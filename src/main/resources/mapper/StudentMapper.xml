<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.demo.MybatisApplication.repository.StudentRepository">

    <resultMap id="StudentResultMap" type="com.demo.MybatisApplication.model.StudentEntity">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="email" column="email"/>
        <result property="age" column="age"/>

        <collection property="subjects" column="id" ofType="com.demo.MybatisApplication.model.SubjectEntity" select="findSubjectsByStudentId">
        </collection>
    </resultMap>

    <resultMap id="SubjectResultMap" type="com.demo.MybatisApplication.model.SubjectEntity">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
    </resultMap>

    <!-- Insert student -->
    <insert id="saveStudent" parameterType="com.demo.MybatisApplication.model.StudentEntity" useGeneratedKeys="true" keyProperty="id">
        <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
            SELECT LASTVAL() AS id
        </selectKey>
        INSERT INTO student (id, name, email, age)
        VALUES (#{id}, #{name}, #{email}, #{age})
    </insert>

    <!-- Add subjects to student -->
    <insert id="updateSubjectsToStudent" useGeneratedKeys="true" keyProperty="id">
        <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
            SELECT LASTVAL() AS id
        </selectKey>
        INSERT INTO student_subject (student_id, subject_id)
        VALUES
        <foreach collection="subjects" item="subject" separator=",">
            (#{studentId}, #{subject.id})
        </foreach>
        RETURNING id
    </insert>

    <!-- Get student by ID -->
    <select id="findStudentById" resultMap="StudentResultMap" parameterType="long">
        SELECT id, name, email, age
        FROM student
        WHERE id = #{id}
    </select>

    <!-- Get student with subjects -->
    <select id="findStudentWithSubjects" resultMap="StudentResultMap" parameterType="long">
        SELECT s.id, s.name, s.email, s.age, sb.id, sb.name AS name
        FROM student s
        LEFT JOIN student_subject ss ON s.id = ss.student_id
        LEFT JOIN subject sb ON ss.subject_id = sb.id
        WHERE s.id = #{id}
    </select>

    <!-- Get all students -->
    <select id="findAllStudents" resultMap="StudentResultMap" resultType="com.demo.MybatisApplication.model.StudentEntity">
        SELECT id, name, email, age FROM student
<!--        SELECT id, id,student_id from student_subject;-->
    </select>

    <!-- Get subjects by student ID-->
    <select id="findSubjectsByStudentId" parameterType="long" resultMap="SubjectResultMap">
        SELECT sb.id, sb.name AS name
        FROM subject sb
        INNER JOIN student_subject ss ON sb.id = ss.subject_id
        WHERE ss.student_id = #{id}
    </select>

</mapper>
